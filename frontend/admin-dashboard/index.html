<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard - Attendance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#1e40af" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="./manifest.json" />
    <link rel="stylesheet" href="./styles.css" />
    <script>
      (function(){try{var t=localStorage.getItem('attendance-theme');if(t==='dark'||t==='light')document.documentElement.setAttribute('data-theme',t);else document.documentElement.setAttribute('data-theme','light');}catch(e){document.documentElement.setAttribute('data-theme','light');}})();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </head>
  <body>
    <div class="app">
      <header class="top-header">
        <div class="brand">
          <img src="./images/ocean-badge.png" alt="The Ocean Of Knowledge School" class="brand-badge" />
          <div class="brand-text">
            <div class="brand-name">The Ocean Of Knowledge School</div>
            <div class="brand-subtitle">Attendance Admin Dashboard</div>
          </div>
        </div>
        <div class="header-actions">
          <button type="button" class="theme-toggle" id="theme-toggle-btn" aria-label="Toggle dark mode" title="Dark / Light mode">
            <span class="icon-sun" aria-hidden="true">‚òÄÔ∏è</span>
            <span class="icon-moon" aria-hidden="true">üåô</span>
          </button>
          <span class="user-pill" id="admin-user-label">Logged in</span>
          <button type="button" class="btn-logout" id="admin-logout-btn">Logout</button>
        </div>
      </header>

      <nav class="tabs">
        <div class="tab active" data-tab="children">Children & QR Codes</div>
        <div class="tab" data-tab="attendance">Today departures</div>
        <div class="tab" data-tab="history">History departures</div>
        <div class="tab" data-tab="teachers">Teachers</div>
        <div class="tab" data-tab="export">Export</div>
      </nav>

      <main>
        <div class="welcome-banner" id="welcome-banner">
          <span class="welcome-text">Welcome back, <span id="welcome-name">‚Äî</span>!</span>
          <span class="welcome-sub" id="welcome-sub">Ready to make today smooth?</span>
        </div>
        <section id="tab-children" class="active">
          <div class="two-column">
          <div class="column">
            <div class="card">
              <h2>Register new child</h2>
              <p class="small">
                Add a learner with their full name, class, parent phone, and three holder photos. The QR code is generated after registration; gate staff will see these photos when scanning.
              </p>
              <form id="register-child-form">
                <div class="grid">
                  <div class="full-width">
                    <label for="child-full-name-input">Child‚Äôs full name</label>
                    <input id="child-full-name-input" type="text" placeholder="e.g. John Okello" required />
                  </div>
                  <div>
                    <label for="child-class-input">Class</label>
                    <input id="child-class-input" type="text" placeholder="e.g. P3" />
                  </div>
                  <div>
                    <label for="child-parent-phone-input">Parent‚Äôs phone number</label>
                    <input id="child-parent-phone-input" type="tel" placeholder="+2567XXXXXXXX" />
                  </div>
                  <div class="full-width register-holder-slot" data-slot="0">
                    <label>Holder 1 photo <span class="required-dot">(at least one required)</span></label>
                    <div class="holder-register-preview" id="register-holder-preview-0"></div>
                    <div class="holder-register-actions">
                      <input type="file" id="holder-photo-1" accept="image/*" class="holder-register-file" data-slot="0" />
                      <button type="button" class="btn-secondary btn-camera" data-slot="0">Take photo</button>
                    </div>
                    <div class="holder-register-confirm" id="register-holder-confirm-0" hidden>
                      <button type="button" class="btn-primary btn-done-photo" data-slot="0">Done</button>
                      <button type="button" class="btn-secondary btn-cancel-photo" data-slot="0">Cancel</button>
                    </div>
                  </div>
                  <div class="full-width register-holder-slot" data-slot="1">
                    <label>Holder 2 photo <span class="muted">(optional)</span></label>
                    <div class="holder-register-preview" id="register-holder-preview-1"></div>
                    <div class="holder-register-actions">
                      <input type="file" id="holder-photo-2" accept="image/*" class="holder-register-file" data-slot="1" />
                      <button type="button" class="btn-secondary btn-camera" data-slot="1">Take photo</button>
                    </div>
                    <div class="holder-register-confirm" id="register-holder-confirm-1" hidden>
                      <button type="button" class="btn-primary btn-done-photo" data-slot="1">Done</button>
                      <button type="button" class="btn-secondary btn-cancel-photo" data-slot="1">Cancel</button>
                    </div>
                  </div>
                  <div class="full-width register-holder-slot" data-slot="2">
                    <label>Holder 3 photo <span class="muted">(optional)</span></label>
                    <div class="holder-register-preview" id="register-holder-preview-2"></div>
                    <div class="holder-register-actions">
                      <input type="file" id="holder-photo-3" accept="image/*" class="holder-register-file" data-slot="2" />
                      <button type="button" class="btn-secondary btn-camera" data-slot="2">Take photo</button>
                    </div>
                    <div class="holder-register-confirm" id="register-holder-confirm-2" hidden>
                      <button type="button" class="btn-primary btn-done-photo" data-slot="2">Done</button>
                      <button type="button" class="btn-secondary btn-cancel-photo" data-slot="2">Cancel</button>
                    </div>
                  </div>
                </div>
                <div class="mt">
                  <button class="btn-primary" type="submit">Register child</button>
                </div>
              </form>
              <div class="status" id="register-child-status"></div>
            </div>
          </div>

          <div class="column">
            <div class="card">
              <div class="card-header-row">
                <div>
                  <h2>Children & QR Codes</h2>
                  <p class="small">
                    One QR per learner. Gate staff scan it once to see this child and their three holder photos.
                  </p>
                </div>
                <div class="header-actions">
                  <button class="btn-secondary" id="refresh-children-btn" type="button">
                    Refresh
                  </button>
                  <button class="btn-secondary" id="generate-qr-btn" type="button">
                    Generate QRs
                  </button>
                  <button class="btn-secondary" id="show-hidden-qr-btn" type="button" disabled>
                    Show hidden
                  </button>
                </div>
              </div>
              <div class="small mt">
                Each learner has a single QR (id + name). Scanning it loads the child and their three photos from the database.
              </div>
              <div class="qr-grid" id="qr-grid"></div>
            </div>
          </div>
          </div>
          <div class="card children-list-card">
            <h2>All registered children</h2>
            <p class="small">View and edit all learners (including those registered earlier). Use Edit to change details or replace holder photos. Delete removes the child from the system permanently (including picker photos and attendance records).</p>
            <div class="search-filter-bar mt">
              <div class="search-filter-segment search-segment">
                <span class="segment-label">Search</span>
                <input type="text" id="children-search-input" class="segment-input" placeholder="By name..." autocomplete="off" />
              </div>
              <div class="search-filter-segment filter-segment">
                <span class="segment-label">Filter</span>
                <select id="children-filter-class" class="segment-select">
                  <option value="">All classes</option>
                </select>
              </div>
            </div>
            <div class="table-wrap">
              <table id="children-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Full name</th>
                    <th>Class</th>
                    <th>Parent phone</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="children-table-body"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="tab-attendance">
          <div class="card">
            <h2>Today departures</h2>
            <button class="btn-secondary" id="refresh-attendance-btn" type="button">
              Refresh
            </button>
            <div class="small" id="attendance-summary"></div>
            <div class="table-wrap">
              <table id="attendance-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Child</th>
                    <th>Class</th>
                    <th>Teacher</th>
                    <th>Holder who picked</th>
                    <th>Action</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="tab-history">
          <div class="card">
            <h2>History departures</h2>
            <p class="small">Open a date below to view that day‚Äôs departure table. Search by date or filter by month.</p>
            <div class="history-toolbar">
              <div class="history-search-row">
                <label for="history-search-date" class="sr-only">Search by date</label>
                <input type="date" id="history-search-date" />
                <button type="button" class="btn-secondary" id="history-search-btn">Search date</button>
              </div>
              <div class="history-filter-row">
                <label for="history-filter-month">Filter by month</label>
                <select id="history-filter-month">
                  <option value="">All months</option>
                </select>
              </div>
              <button class="btn-secondary" id="refresh-history-dates-btn" type="button">Refresh list</button>
            </div>
            <div class="small mt" id="history-dates-summary"></div>
            <div class="history-dates-list" id="history-dates-list"></div>
            <div class="mt" id="history-table-wrap" style="display: none;">
              <h3 id="history-table-title"></h3>
              <div class="table-wrap">
                <table id="history-attendance-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Child</th>
                      <th>Class</th>
                      <th>Teacher</th>
                      <th>Holder who picked</th>
                      <th>Action</th>
                      <th>Time</th>
                    </tr>
                  </thead>
                  <tbody id="history-attendance-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-teachers">
          <div class="card">
            <h2>Manage Teachers</h2>
            <form id="add-teacher-form">
              <div class="grid">
                <div>
                  <label for="teacher-name-input">Name</label>
                  <input id="teacher-name-input" type="text" required />
                </div>
                <div>
                  <label for="teacher-phone-input">Phone</label>
                  <input id="teacher-phone-input" type="tel" required />
                </div>
                <div>
                  <label for="teacher-pin-input">4-digit PIN</label>
                  <input id="teacher-pin-input" type="text" maxlength="4" required />
                </div>
                <div>
                  <label for="teacher-access-input">Access</label>
                  <select id="teacher-access-input">
                    <option value="both">Both (Scanner + Admin)</option>
                    <option value="scanner">Scanner only</option>
                    <option value="admin">Admin only</option>
                  </select>
                </div>
              </div>
              <div class="mt">
                <button class="btn-primary" type="submit">Add Teacher</button>
              </div>
            </form>
            <div class="status" id="teachers-status"></div>
          </div>

          <div class="card">
            <h2>Teachers List</h2>
            <button class="btn-secondary" id="refresh-teachers-btn" type="button">
              Refresh
            </button>
            <div class="table-wrap">
              <table id="teachers-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Access</th>
                    <th>Active</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="tab-export">
          <div class="card">
            <h2>Export Attendance</h2>
            <p class="small">
              Export all attendance data as CSV, or pick a date from history to export that day only.
              Files open in Excel or Google Sheets.
            </p>
            <button class="btn-primary" id="export-attendance-btn" type="button">
              Download all (full CSV)
            </button>
          </div>
          <div class="card mt">
            <h2>Export from history</h2>
            <p class="small">Export a single day‚Äôs departures. Select a date that has records (same list as History departures).</p>
            <div class="history-dates-list" id="export-history-dates-list"></div>
            <p class="small mt" id="export-history-hint">Load the Export tab to see dates.</p>
          </div>
        </section>
      </main>
    </div>

    <div class="modal-overlay" id="edit-child-modal" aria-hidden="true">
      <div class="modal-box">
        <h2>Edit child</h2>
        <form id="edit-child-form">
          <div class="grid">
            <div class="full-width">
              <label for="edit-child-full-name">Full name</label>
              <input id="edit-child-full-name" type="text" required />
            </div>
            <div>
              <label for="edit-child-class">Class</label>
              <input id="edit-child-class" type="text" />
            </div>
            <div>
              <label for="edit-child-parent-phone">Parent phone</label>
              <input id="edit-child-parent-phone" type="tel" />
            </div>
          </div>
          <div class="mt">
            <label class="block-label">Holder photos and names</label>
            <p class="small" style="margin-bottom: 0.5rem;">Names show under each photo when scanning. You can edit names here or replace a photo (filename becomes the name).</p>
            <div class="holder-photos-edit" id="holder-photos-edit">
              <div class="holder-edit-slot" data-slot="0">
                <div class="holder-thumb-wrap"><img class="holder-thumb" alt="Holder 1" /></div>
                <label class="small" for="holder-name-0">Holder 1 name</label>
                <input type="text" class="holder-name-input" id="holder-name-0" placeholder="e.g. Sharon" data-slot="0" />
                <div class="holder-photo-actions">
                  <input type="file" class="holder-replace-input" accept="image/*" data-slot="0" />
                  <button type="button" class="btn-remove-photo" data-slot="0">Remove photo</button>
                </div>
              </div>
              <div class="holder-edit-slot" data-slot="1">
                <div class="holder-thumb-wrap"><img class="holder-thumb" alt="Holder 2" /></div>
                <label class="small" for="holder-name-1">Holder 2 name</label>
                <input type="text" class="holder-name-input" id="holder-name-1" placeholder="e.g. John" data-slot="1" />
                <div class="holder-photo-actions">
                  <input type="file" class="holder-replace-input" accept="image/*" data-slot="1" />
                  <button type="button" class="btn-remove-photo" data-slot="1">Remove photo</button>
                </div>
              </div>
              <div class="holder-edit-slot" data-slot="2">
                <div class="holder-thumb-wrap"><img class="holder-thumb" alt="Holder 3" /></div>
                <label class="small" for="holder-name-2">Holder 3 name</label>
                <input type="text" class="holder-name-input" id="holder-name-2" placeholder="e.g. Mary" data-slot="2" />
                <div class="holder-photo-actions">
                  <input type="file" class="holder-replace-input" accept="image/*" data-slot="2" />
                  <button type="button" class="btn-remove-photo" data-slot="2">Remove photo</button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-actions mt">
            <button type="button" class="btn-secondary" id="edit-child-cancel">Cancel</button>
            <button type="submit" class="btn-primary">Save</button>
          </div>
        </form>
        <div class="status" id="edit-child-status"></div>
      </div>
    </div>

    <div class="modal-overlay" id="camera-capture-modal" aria-hidden="true">
      <div class="modal-box modal-camera">
        <h2>Take photo</h2>
        <p class="small">Position the person in the frame, then tap Capture.</p>
        <div class="camera-video-wrap">
          <video id="camera-video" autoplay playsinline muted></video>
        </div>
        <div class="modal-actions mt">
          <button type="button" class="btn-secondary" id="camera-capture-cancel">Cancel</button>
          <button type="button" class="btn-primary" id="camera-capture-btn">Capture</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="hidden-qr-modal" aria-hidden="true">
      <div class="modal-box modal-box-hidden-qr">
        <h2>Hidden QR codes</h2>
        <p class="small">These QRs are hidden from the grid. Click Unhide to show a QR again.</p>
        <div class="hidden-qr-list" id="hidden-qr-list"></div>
        <div class="modal-actions mt">
          <button type="button" class="btn-secondary" id="hidden-qr-modal-close">Close</button>
        </div>
      </div>
    </div>

    <script src="./theme.js"></script>
    <script src="./dashboard.js"></script>
  </body>
  </html>

